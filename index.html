<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juliano Entregas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        decanter: {
                            black: '#0f172a', // Slate 900
                            dark: '#1e293b',  // Slate 800
                            surface: '#334155', // Slate 700
                            blue: '#2563eb',  // Blue 600
                            accent: '#3b82f6' // Blue 500
                        }
                    },
                    padding: {
                        'safe-bottom': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Animações Suaves */
        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .tab-content.active { display: block; opacity: 1; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Input Styles Otimizados para Touch */
        .input-field {
            width: 100%;
            background-color: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 14px; /* Mais espaço para o dedo */
            font-size: 16px; /* Evita zoom automático no iOS */
            border-radius: 12px;
            margin-bottom: 16px;
            outline: none;
            transition: all 0.2s;
            appearance: none; /* Remove estilos nativos feios */
        }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        
        /* Card Styles */
        .mobile-card {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 0px; /* Removido margem pois agora agrupamos */
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        label { display: block; margin-bottom: 8px; font-weight: 600; color: #94a3b8; font-size: 0.9rem; }
        
        /* Ajuste Navigation Bar Mobile */
        .nav-btn.active span { color: #3b82f6; }
        .nav-btn.active .material-icons { transform: translateY(-2px); text-shadow: 0 4px 12px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="flex flex-col min-h-screen pb-24 md:pb-0 selection:bg-blue-500 selection:text-white">

    <header class="bg-decanter-dark/90 backdrop-blur-md border-b border-gray-700 p-4 sticky top-0 z-40 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600/20 p-2 rounded-lg">
                    <span class="material-icons text-2xl text-blue-500">local_shipping</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-none">Juliano</h1> 
                    <span class="text-xs text-blue-400 font-medium tracking-wider">ENTREGAS</span>
                </div>
            </div>
            <button onclick="window.location.reload()" class="p-2 text-gray-400 md:hidden">
                <span class="material-icons text-xl">refresh</span>
            </button>
        </div>
    </header>

    <main class="flex-grow w-full p-4 mx-auto max-w-4xl">
        
        <section id="page-add" class="tab-content active">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Nova Entrega</h2>
                <button onclick="closeDaySummary()" class="flex items-center gap-1 px-3 py-2 text-xs font-bold transition border rounded-lg active:scale-95 bg-green-900/50 text-green-300 border-green-700">
                    <span class="material-icons text-sm">assignment_turned_in</span> Fechar Dia
                </button>
            </div>
            
            <form id="deliveryForm" class="p-1 rounded-xl bg-decanter-dark md:p-6 md:shadow-xl md:border md:border-gray-700 bg-transparent md:bg-decanter-dark">
                <div>
                    <label for="data">Data da Entrega</label>
                    <input type="date" id="data" class="input-field" required>
                </div>

                <div>
                    <label for="local">Origem</label>
                    <div class="relative">
                        <select id="local" class="appearance-none input-field" onchange="toggleOutros()">
                            <option value="Entrega">Entrega (Padrão)</option>
                            <option value="Matriz">Matriz</option>
                            <option value="Outros">Outros...</option>
                        </select>
                        <span class="material-icons absolute text-gray-500 pointer-events-none right-4 top-4">expand_more</span>
                    </div>
                    <input type="text" id="localOutros" class="hidden mt-2 animate-pulse input-field" placeholder="Digite o nome do local...">
                </div>

                <div>
                    <label for="paraQuem">Para Quem</label>
                    <div class="relative">
                        <select id="paraQuem" class="appearance-none input-field" required>
                            <option value="" disabled selected>Selecione a Planilha...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                        <span class="material-icons absolute text-gray-500 pointer-events-none right-4 top-4">expand_more</span>
                    </div>
                </div>
                <div>
                    <label for="destino">Destino / Cliente</label>
                    <input type="text" id="destino" placeholder="Ex: Rua XV de Novembro, 100" class="input-field" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="km">KM Rodados</label>
                        <div class="relative">
                            <input type="number" step="0.1" inputmode="decimal" id="km" placeholder="0.0" class="pl-10 input-field" required>
                            <span class="absolute text-sm font-bold text-gray-500 left-3 top-3.5">KM</span>
                        </div>
                    </div>
                    <div>
                        <label for="valor">Valor Cobrado</label>
                        <div class="relative">
                            <input type="number" step="0.01" inputmode="decimal" id="valor" placeholder="0.00" class="pl-10 input-field" required>
                            <span class="absolute text-sm font-bold text-green-500 left-3 top-3.5">R$</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="obs">Observação</label>
                    <textarea id="obs" rows="3" class="input-field" placeholder="Algum detalhe extra?"></textarea>
                </div>

                <div class="h-4"></div> <button type="submit" class="flex items-center justify-center w-full gap-2 px-6 py-4 text-lg font-bold text-white transition transform rounded-xl bg-blue-600 active:bg-blue-700 shadow-lg shadow-blue-900/50 active:scale-[0.98]">
                    <span class="material-icons">save</span> Salvar Entrega
                </button>
            </form>
        </section>

        <section id="page-list" class="tab-content">
            <div class="sticky top-0 z-30 flex items-center justify-between py-2 mb-6 bg-[#0f172a]">
                <div>
                    <h2 class="text-xl font-bold">Histórico</h2>
                    <p class="text-xs text-gray-400" id="totalCount">Carregando...</p>
                </div>
                <button onclick="deleteAll()" class="flex items-center gap-1 px-3 py-1.5 text-xs font-bold transition border rounded-lg bg-red-900/30 text-red-400 hover:bg-red-900/50 border-red-900/50">
                    <span class="material-icons text-sm">delete_forever</span> Limpar Tudo
                </button>
            </div>

            <div id="mobileList" class="space-y-6 pb-safe-bottom md:hidden">
                </div>

            <div class="hidden overflow-hidden border rounded-xl md:block bg-decanter-dark shadow-xl border-gray-700">
                <table class="w-full text-left border-collapse">
                    <thead class="text-[11px] font-bold tracking-wider uppercase bg-gray-800/50 text-gray-400">
                        <tr>
                            <th class="p-4">Data</th>
                            <th class="p-4">Origem / #Pl</th>
                            <th class="p-4">Destino</th>
                            <th class="p-4 text-right">KM</th>
                            <th class="p-4 text-right">Valor</th>
                            <th class="p-4">Obs</th>
                            <th class="p-4 text-center">Ação</th> </tr>
                    </thead>
                    <tbody id="desktopTableBody" class="text-sm divide-y divide-gray-700/50">
                        </tbody>
                </table>
            </div>

            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 opacity-50">
                <span class="mb-4 text-6xl text-gray-600 material-icons">history</span>
                <p class="text-lg font-medium text-gray-400">Nenhuma entrega ainda.</p>
                <button onclick="switchTab('page-add')" class="mt-4 text-sm font-bold text-blue-400">Adicionar a primeira</button>
            </div>
        </section>

        <section id="page-excel" class="tab-content">
            <h2 class="mb-6 text-xl font-bold">Relatórios</h2>
            
            <div class="relative p-8 overflow-hidden border rounded-2xl shadow-xl bg-gradient-to-br from-green-900/20 to-decanter-dark border-green-900/30">
                <div class="absolute top-0 right-0 w-24 h-24 -mt-4 -mr-4 rounded-full blur-3xl bg-green-500 opacity-20"></div>
                
                <h3 class="flex items-center gap-2 mb-4 text-xl font-bold text-white">
                    <span class="text-green-500 material-icons">filter_alt</span> Filtro de Período
                </h3>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-xs uppercase text-green-400">Data Inicial</label>
                        <input type="date" id="excelStart" class="input-field bg-black/20 border-green-900/50">
                    </div>
                    <div>
                        <label class="text-xs uppercase text-green-400">Data Final</label>
                        <input type="date" id="excelEnd" class="input-field bg-black/20 border-green-900/50">
                    </div>
                </div>

                <p class="mb-8 text-sm leading-relaxed text-gray-400">
                    Gera um **único** arquivo Excel consolidado, separando os dados dos grupos (1, 2 e 3) em colunas lado a lado, com totais diários e colunas G e N vazias, **agora com formatação profissional**.
                </p>
                
                <button onclick="generateExcel()" class="flex items-center justify-center w-full gap-3 px-8 py-4 font-bold text-white transition rounded-xl bg-green-600 hover:bg-green-500 active:bg-green-700 shadow-lg shadow-green-900/40">
                    <span class="material-icons">download</span> Baixar Relatório Consolidado
                </button>
            </div>
        </section>

        </main>

    <nav class="fixed bottom-0 left-0 z-50 w-full border-t md:hidden backdrop-blur-xl bg-[#1e293b]/95 border-gray-700/50 pb-[env(safe-area-inset-bottom)]">
        <div class="flex items-center justify-between h-16 px-6">
            <button onclick="switchTab('page-add')" class="flex flex-col items-center justify-center w-12 h-12 transition-all duration-300 rounded-full nav-btn active">
                <span class="mb-0.5 text-2xl material-icons">add_circle</span>
                <span class="text-[9px] font-medium">Novo</span>
            </button>
            <button onclick="switchTab('page-list')" class="flex flex-col items-center justify-center w-12 h-12 text-gray-400 transition-all duration-300 rounded-full nav-btn">
                <span class="mb-0.5 text-2xl material-icons">list_alt</span>
                <span class="text-[9px] font-medium">Lista</span>
            </button>
            <button onclick="switchTab('page-excel')" class="flex flex-col items-center justify-center w-12 h-12 text-gray-400 transition-all duration-300 rounded-full nav-btn">
                <span class="mb-0.5 text-2xl material-icons">analytics</span>
                <span class="text-[9px] font-medium">Excel</span>
            </button>
            </div>
    </nav>
    
    <div class="fixed left-0 top-0 z-30 hidden w-64 h-full px-4 pt-24 space-y-2 border-r md:flex flex-col bg-decanter-dark border-gray-700">
        <button onclick="switchTab('page-add')" class="flex items-center gap-3 px-4 py-3 font-bold text-white transition rounded-lg nav-desk-btn w-full text-left bg-blue-600 shadow-lg shadow-blue-900/50">
            <span class="material-icons">add_circle</span> Adicionar
        </button>
        <button onclick="switchTab('page-list')" class="flex items-center gap-3 px-4 py-3 transition rounded-lg nav-desk-btn w-full text-left text-gray-400 hover:bg-gray-800 hover:text-white">
            <span class="material-icons">list_alt</span> Histórico
        </button>
        <button onclick="switchTab('page-excel')" class="flex items-center gap-3 px-4 py-3 transition rounded-lg nav-desk-btn w-full text-left text-gray-400 hover:bg-gray-800 hover:text-white">
            <span class="material-icons">analytics</span> Relatórios
        </button>
        <div class="px-4 mt-auto mb-6">
            <div class="p-4 border rounded-xl bg-gray-800/50 border-gray-700">
                <p class="mb-1 text-xs text-gray-400">Total acumulado</p>
                <p class="text-xl font-bold text-green-400" id="sidebarTotal">R$ 0,00</p>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 md:top-24 md:right-8 md:left-auto md:translate-x-0 bg-gray-800 border border-green-500/30 text-white px-6 py-4 rounded-xl shadow-2xl transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3 z-[60] min-w-[300px]">
        <div class="p-2 rounded-full bg-green-500/20">
            <span class="text-xl text-green-500 material-icons">check</span>
        </div>
        <div>
            <h4 class="text-sm font-bold">Sucesso</h4>
            <span id="toastMsg" class="text-xs text-gray-300">Operação realizada</span>
        </div>
    </div>

    <div id="summaryModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="w-full max-w-sm p-6 transition-all transform border rounded-2xl shadow-2xl bg-decanter-dark border-gray-700 scale-100">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Fechamento do Dia</h3>
                <button onclick="document.getElementById('summaryModal').classList.add('hidden')" class="text-gray-400 hover:text-white">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <p class="mb-1 text-sm text-gray-400">Data Selecionada</p>
            <p class="pb-2 mb-6 text-lg font-bold text-white border-b border-gray-700" id="summaryDate">--/--/----</p>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-3 rounded-lg bg-gray-800">
                    <span class="text-xs uppercase text-gray-400">Total KM</span>
                    <p class="text-xl font-bold text-blue-400" id="summaryKm">0.0</p>
                </div>
                <div class="p-3 rounded-lg bg-gray-800">
                    <span class="text-xs uppercase text-gray-400">Total Valor</span>
                    <p class="text-xl font-bold text-green-400" id="summaryVal">R$ 0,00</p>
                </div>
            </div>
            <div class="mb-4 text-xs text-center text-gray-500">
                Este é apenas um resumo visual. Os dados continuam salvos no histórico.
            </div>
            <button onclick="document.getElementById('summaryModal').classList.add('hidden')" class="flex items-center justify-center w-full gap-2 px-6 py-3 font-bold text-white transition transform rounded-xl bg-blue-600 active:bg-blue-700 shadow-lg shadow-blue-900/50 active:scale-[0.98]">
                Entendi
            </button>
        </div>
    </div>
    

    <script>
        // --- 1. FUNÇÕES GERAIS ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-btn, .nav-desk-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'shadow-blue-900/50');
                btn.classList.add('text-gray-400', 'hover:bg-gray-800', 'hover:text-white');
            });

            if (tabId === 'page-add') {
                const addBtn = document.querySelector('.nav-btn:nth-child(1)');
                const deskAddBtn = document.querySelector('.nav-desk-btn:nth-child(1)');
                addBtn.classList.add('active');
                deskAddBtn.classList.remove('text-gray-400', 'hover:bg-gray-800', 'hover:text-white');
                deskAddBtn.classList.add('bg-blue-600', 'shadow-lg', 'shadow-blue-900/50');
            } else if (tabId === 'page-list') {
                const listBtn = document.querySelector('.nav-btn:nth-child(2)');
                const deskListBtn = document.querySelector('.nav-desk-btn:nth-child(2)');
                listBtn.classList.add('active');
                deskListBtn.classList.add('active');
            } else if (tabId === 'page-excel') {
                const excelBtn = document.querySelector('.nav-btn:nth-child(3)');
                const deskExcelBtn = document.querySelector('.nav-desk-btn:nth-child(3)');
                excelBtn.classList.add('active');
                deskExcelBtn.classList.add('active');
            }
            
            // Recarrega a lista quando for para a aba de histórico/listagem
            if (tabId === 'page-list') {
                renderList();
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            
            toastMsg.innerText = message;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            toast.classList.add('opacity-100', 'translate-y-0');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            }, 3000);
        }

        function toggleOutros() {
            const local = document.getElementById('local').value;
            const localOutros = document.getElementById('localOutros');
            if (local === 'Outros') {
                localOutros.classList.remove('hidden');
                localOutros.setAttribute('required', 'true');
            } else {
                localOutros.classList.add('hidden');
                localOutros.removeAttribute('required');
            }
        }

        // --- 2. SALVAR DADOS ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data').value = today;
            
            document.getElementById('excelStart').value = today;
            document.getElementById('excelEnd').value = today;

            renderList(); // Carrega a lista ao iniciar
            updateSidebarTotal();
        });

        document.getElementById('deliveryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let localFinal = document.getElementById('local').value;
            if (localFinal === 'Outros') {
                localFinal = document.getElementById('localOutros').value.trim();
            }

            if (document.getElementById('local').value === 'Outros' && !localFinal) {
                alert('Por favor, preencha o campo do local!');
                return;
            }

            const entrega = {
                id: Date.now(),
                data: document.getElementById('data').value,
                local: localFinal,
                destino: document.getElementById('destino').value.trim(),
                km: parseFloat(document.getElementById('km').value),
                valor: parseFloat(document.getElementById('valor').value),
                obs: document.getElementById('obs').value.trim(),
                paraQuem: document.getElementById('paraQuem').value
            };
            
            if (!entrega.paraQuem) {
                alert('Selecione o campo "Para Quem"!');
                return;
            }

            const entregas = JSON.parse(localStorage.getItem('entregasDecanter') || '[]');
            entregas.push(entrega);
            localStorage.setItem('entregasDecanter', JSON.stringify(entregas));
            
            showToast('Entrega salva!');
            
            this.reset();
            document.getElementById('data').value = today;
            document.getElementById('local').value = 'Entrega';
            document.getElementById('paraQuem').value = '';
            toggleOutros();

            if(navigator.vibrate) navigator.vibrate(50);
            updateSidebarTotal();
            renderList(); // Atualiza a lista após salvar
        });

        // --- 3.1 RESUMO DO DIA (FECHAR DIA) ---
        function closeDaySummary() {
            const selectedDate = document.getElementById('data').value;
            const entregas = JSON.parse(localStorage.getItem('entregasDecanter') || '[]');
            
            // Filtra entregas da data selecionada
            const todayEntregas = entregas.filter(e => e.data === selectedDate);
            
            const totalKm = todayEntregas.reduce((sum, item) => sum + item.km, 0);
            const totalVal = todayEntregas.reduce((sum, item) => sum + item.valor, 0);

            document.getElementById('summaryDate').innerText = new Date(selectedDate).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            document.getElementById('summaryKm').innerText = totalKm.toFixed(1) + ' km';
            document.getElementById('summaryVal').innerText = totalVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            document.getElementById('summaryModal').classList.remove('hidden');
        }

        // --- 4. FUNÇÃO PARA EXCLUIR ITEM ---
        function deleteDelivery(id) {
            if (!confirm("Tem certeza que deseja excluir esta entrega?")) return;
            
            let entregas = JSON.parse(localStorage.getItem('entregasDecanter') || '[]');
            entregas = entregas.filter(e => e.id !== id);
            localStorage.setItem('entregasDecanter', JSON.stringify(entregas));
            
            showToast('Entrega excluída!');
            renderList();
            updateSidebarTotal();
        }

        function deleteAll() {
            if (!confirm("VOCÊ TEM CERTEZA? Isso apagará todas as entregas salvas!")) return;
            localStorage.removeItem('entregasDecanter');
            showToast('Histórico limpo!');
            renderList();
            updateSidebarTotal();
        }
        
        // --- 5. RENDERIZAÇÃO DA LISTA ---
        function renderList() {
            const entregas = JSON.parse(localStorage.getItem('entregasDecanter') || '[]');
            
            document.getElementById('totalCount').innerText = `${entregas.length} entregas salvas`;
            
            const mobileList = document.getElementById('mobileList');
            const desktopTableBody = document.getElementById('desktopTableBody');
            mobileList.innerHTML = '';
            desktopTableBody.innerHTML = '';

            if (entregas.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            // Agrupa por data (garantindo que seja UTC para a data ser consistente)
            const groupedByDate = entregas.sort((a, b) => new Date(b.data + 'T00:00:00Z') - new Date(a.data + 'T00:00:00Z'))
                                        .reduce((acc, item) => {
                                            if (!acc[item.data]) {
                                                acc[item.data] = [];
                                            }
                                            acc[item.data].push(item);
                                            return acc;
                                        }, {});

            // Renderiza a lista móvel
            for (const date in groupedByDate) {
                const items = groupedByDate[date];
                const dayTotalVal = items.reduce((sum, item) => sum + item.valor, 0);
                const dateFmt = new Date(date + 'T00:00:00Z').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit'});

                // --- MOBILE RENDER (Group Header) ---
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `
                    <div class="flex justify-between items-end mb-2 px-1">
                        <div class="text-sm font-bold text-gray-300 uppercase">${dateFmt}</div>
                        <div class="text-xs text-right">
                            <div class="text-gray-400">Total Dia</div>
                            <span class="text-green-400 font-bold">${dayTotalVal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</span>
                        </div>
                    </div>
                `;
                mobileList.appendChild(groupDiv);

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = "mobile-card mb-2"; // Cartão Mobile com botão de exclusão
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="text-base font-bold text-white leading-tight">${item.destino}</h4>
                                    <span class="text-green-400 text-sm font-bold">${item.valor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</span>
                                </div>
                                <div class="flex items-center gap-4 text-xs text-gray-400">
                                    <div class="flex items-center gap-1"><span class="material-icons text-sm text-blue-500">place</span> ${item.local}</div>
                                    <div class="flex items-center gap-1"><span class="material-icons text-sm text-orange-500">speed</span> ${item.km} km</div>
                                    <div class="flex items-center gap-1 text-yellow-400 font-bold">#${item.paraQuem}</div>
                                </div>
                                ${item.obs ? `<p class="mt-2 text-xs text-gray-500 italic">Obs: ${item.obs}</p>` : ''}
                            </div>
                            <button onclick="deleteDelivery(${item.id})" class="text-red-500/70 hover:text-red-400 ml-4 p-1 rounded-full active:scale-95 transition">
                                <span class="material-icons text-xl">close</span>
                            </button>
                        </div>
                    `;
                    mobileList.appendChild(card);
                });
                
                // Adiciona um espaço extra entre os grupos de dias no mobile
                const spacer = document.createElement('div');
                spacer.className = "h-4";
                mobileList.appendChild(spacer);
            }

            // Renderiza a tabela desktop
            entregas.forEach(item => {
                const row = desktopTableBody.insertRow();
                row.className = "hover:bg-gray-800 transition";
                row.innerHTML = `
                    <td class="p-4">${new Date(item.data + 'T00:00:00Z').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit'})}</td>
                    <td class="p-4">${item.local} / <span class="text-yellow-400 font-bold">#${item.paraQuem}</span></td>
                    <td class="p-4 text-gray-300">${item.destino}</td>
                    <td class="p-4 text-right text-blue-400">${item.km.toFixed(1).replace('.', ',')} km</td>
                    <td class="p-4 text-right text-green-400 font-bold">${item.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="p-4 text-xs text-gray-500">${item.obs || '-'}</td>
                    <td class="p-4 text-center">
                        <button onclick="deleteDelivery(${item.id})" class="text-red-500/70 hover:text-red-400 p-1 rounded-full active:scale-95 transition">
                            <span class="material-icons text-xl">delete</span>
                        </button>
                    </td>
                `;
            });
        }
        
        function updateSidebarTotal() {
             const entregas = JSON.parse(localStorage.getItem('entregasDecanter') || '[]');
             const totalVal = entregas.reduce((sum, item) => sum + item.valor, 0);
             document.getElementById('sidebarTotal').innerText = totalVal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }


        // --- 6. FUNÇÕES PARA EXCEL ---

        // Função auxiliar para formatar o valor monetário BRL (mantém a vírgula para o Excel)
        function formatCurrencyBRL(value) {
            // Garante que o número não tenha separador de milhares indesejado no Excel
            return value.toFixed(2).replace('.', ','); 
        }

        // Função auxiliar para criar um objeto Date garantido em UTC
        function parseDateAsUTC(dateStr) {
            if (!dateStr) return null;
            // 'YYYY-MM-DD' + 'T00:00:00Z' força o Date a ser criado como meia-noite UTC,
            // eliminando problemas de fuso horário local e garantindo que o dia não seja perdido.
            return new Date(dateStr + 'T00:00:00Z');
        }


        // --- 7. EXCEL AVANÇADO (CORRIGIDO E COM FORMATAÇÃO BONITA) ---
        function generateExcel() {
            const entregas = JSON.parse(localStorage.getItem('entregasDecanter') || '[]');
            
            if (entregas.length === 0) {
                showToast("Nada para exportar.");
                return;
            }

            const startStr = document.getElementById('excelStart').value;
            const endStr = document.getElementById('excelEnd').value;
            
            if(!startStr || !endStr) {
                alert("Selecione as datas.");
                return;
            }

            const startDateObj = parseDateAsUTC(startStr);
            let endDateObj = parseDateAsUTC(endStr);
            // Adiciona 1 dia à data final para incluir o dia inteiro no filtro
            endDateObj.setUTCDate(endDateObj.getUTCDate() + 1); 

            const targets = ['1', '2', '3'];

            // 1. Filtrar por data
            const filtered = entregas.filter(e => {
                const entryDateObj = parseDateAsUTC(e.data);
                return entryDateObj >= startDateObj && entryDateObj < endDateObj;
            });
            
            if (filtered.length === 0) {
                 showToast("Nenhuma entrega encontrada no período selecionado.");
                 return;
            }

            // 2. Agrupar por data e por Target
            const itemsGroupedByDate = filtered.reduce((acc, item) => {
                if (!acc[item.data]) acc[item.data] = {};
                if (!acc[item.data][item.paraQuem]) acc[item.data][item.paraQuem] = [];
                acc[item.data][item.paraQuem].push(item);
                return acc;
            }, {});

            // 3. Obter todas as datas únicas e ordenadas
            const allDates = Object.keys(itemsGroupedByDate).sort();

            const finalAoa = []; // Array of Arrays (Array de Dados)
            let grandTotal = { km: 0, val: 0 };
            
            let currentRowForAoa = 2; // Começa após o cabeçalho (Linhas 0 e 1)

            // 4. Loop por dia
            allDates.forEach(date => {
                const itemsByTarget = itemsGroupedByDate[date];

                // Calcular totais diários por target (usado no próximo bloco de correção)
                const dailyTotals = {};
                targets.forEach(t => {
                    const items = itemsByTarget[t] || [];
                    dailyTotals[t] = { 
                        km: items.reduce((sum, i) => sum + i.km, 0), 
                        val: items.reduce((sum, i) => sum + i.valor, 0) 
                    };
                    grandTotal.km += dailyTotals[t].km;
                    grandTotal.val += dailyTotals[t].val;
                });

                // Acha o Target com o maior número de entradas para alinhamento horizontal
                const maxEntries = Math.max(
                    (itemsByTarget['1'] || []).length,
                    (itemsByTarget['2'] || []).length,
                    (itemsByTarget['3'] || []).length
                );

                // 1. Loop para colocar as Entregas (Alinhamento Horizontal)
                for (let i = 0; i < maxEntries; i++) {
                    const row = [];
                    targets.forEach((target, index) => {
                        const items = itemsByTarget[target] || [];
                        const item = items[i]; // Tenta pegar a i-ésima entrega
                        
                        if (item) {
                            // Dados da entrega formatados
                            row.push(
                                new Date(item.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' }),
                                item.local,
                                item.destino,
                                item.km.toFixed(1).replace('.', ','),
                                formatCurrencyBRL(item.valor),
                                item.obs
                            );
                        } else {
                            // Células vazias para alinhamento
                            row.push('', '', '', '', '', ''); 
                        }
                        
                        // Coluna de separação G ou N
                        if (index < targets.length - 1) {
                            row.push(""); 
                        }
                    });
                    finalAoa.push(row);
                    currentRowForAoa++;
                }


                // --- 2. NOVO BLOCO DE CÁLCULO E INSERÇÃO DE TOTAL DIA (CORRIGIDO) ---
                // Colunas de referência para cada Target
                const targetCols = { 
                    // Total (col 2, 9, 16) | KM (col 3, 10, 17) | Valor (col 4, 11, 18)
                    1: { totalCellCol: 2, totalKmCol: 3, totalValorCol: 4 }, 
                    2: { totalCellCol: 9, totalKmCol: 10, totalValorCol: 11 }, 
                    3: { totalCellCol: 16, totalKmCol: 17, totalValorCol: 18 } 
                };

                const totalRow = new Array(20).fill('');
                let hasAnyDeliveryOnDay = false;
                
                // Montar a linha de total consolidada (usando dailyTotals previamente calculado)
                targets.forEach(target => {
                    const total = dailyTotals[target];
                    const km = total.km;
                    const valor = total.val;
                    
                    // Usa o target como chave para targetCols
                    const { totalCellCol, totalKmCol, totalValorCol } = targetCols[parseInt(target)];

                    // **CORREÇÃO para o problema: Não mostrar se KM e Valor são 0**
                    if (km > 0 || valor > 0) {
                        hasAnyDeliveryOnDay = true;
                        
                        // Célula TOTAL DIA #X (Ex: C3, J3, Q3)
                        totalRow[totalCellCol] = `TOTAL DIA #${target}`; 
                        
                        // Valores KM e Valor formatados
                        totalRow[totalKmCol] = km.toFixed(1).replace('.', ','); 
                        totalRow[totalValorCol] = formatCurrencyBRL(valor); 
                    }
                });

                // **CORREÇÃO para o problema: Linha sendo pulada & Layout**
                // Adiciona a linha de total (e a linha vazia seguinte) apenas se houver alguma entrega no dia.
                if (hasAnyDeliveryOnDay) {
                    finalAoa.push(totalRow);
                    // Adiciona uma linha vazia para separar os dias, seguindo o padrão do seu layout.
                    finalAoa.push(new Array(20).fill('')); 
                    currentRowForAoa += 2;
                }
                // --- FIM DO NOVO BLOCO ---


            }); // Fim do allDates.forEach


            // 4. Linha do Somatório Geral
            const grandTotalRow = [];
            targets.forEach((target, index) => {
                grandTotalRow.push(
                    target,
                    "",
                    "SOMATÓRIO GERAL",
                    grandTotal.km.toFixed(1).replace('.', ','),
                    formatCurrencyBRL(grandTotal.val),
                    ""
                );
                if (index < targets.length - 1) {
                    grandTotalRow.push("");
                }
            });
            finalAoa.push(grandTotalRow);
            currentRowForAoa++;
            finalAoa.push(new Array(20).fill("")); // Duas linhas em branco no final
            finalAoa.push(new Array(20).fill(""));


            // 5. Montar o cabeçalho (Duas linhas)
            const titleRow = [
                "1", "", "", "", "", "", // Target 1 (Col A-F)
                "", // Separador G
                "2", "", "", "", "", "", // Target 2 (Col H-M)
                "", // Separador N
                "3", "", "", "", "", "" // Target 3 (Col O-T)
            ];
            
            const columnHeaders = [
                "Data", "Origem", "Destino", "KM", "Valor (R$)", "Obs", // 6 cols
                "", // Separador G
                "Data", "Origem", "Destino", "KM", "Valor (R$)", "Obs", // 6 cols
                "", // Separador N
                "Data", "Origem", "Destino", "KM", "Valor (R$)", "Obs" // 6 cols
            ];

            const aoaWithHeaders = [
                titleRow,
                columnHeaders,
                ...finalAoa
            ];

            // 6. Gerar a planilha
            const ws = XLSX.utils.aoa_to_sheet(aoaWithHeaders);
            
            // 7. Mesclar células para os títulos (1, 2, 3)
            if (!ws['!merges']) ws['!merges'] = [];
            // Merge "1" over A1:F1
            ws['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }); 
            // Merge "2" over H1:M1 (H é a coluna 7, M é a 12)
            ws['!merges'].push({ s: { r: 0, c: 7 }, e: { r: 0, c: 12 } });
            // Merge "3" over O1:T1 (O é a coluna 14, T é a 19)
            ws['!merges'].push({ s: { r: 0, c: 14 }, e: { r: 0, c: 19 } });

            // 8. Aplicar Estilos
            const headerFill = { fgColor: { rgb: "1E293B" } }; // Slate 800
            const blueFill = { fgColor: { rgb: "2563EB" } }; // Blue 600
            const greenFill = { fgColor: { rgb: "16A34A" } }; // Green 600
            const blackFill = { fgColor: { rgb: "0F172A" } }; // Slate 900
            const whiteFont = { color: { rgb: "FFFFFF" }, bold: true };
            const headerFont = { color: { rgb: "94A3B8" }, bold: true, sz: 10 }; // Gray 400

            // Aplicar estilos ao Título (Row 1)
            [0, 7, 14].forEach(c => {
                 const cellRef = XLSX.utils.encode_cell({ r: 0, c: c });
                 const cell = ws[cellRef];
                 if (cell) {
                    cell.s = { 
                        font: whiteFont, 
                        fill: blueFill, 
                        alignment: { horizontal: 'center', vertical: 'center' } 
                    };
                 }
            });
            
            // Aplicar estilos ao sub-cabeçalho (Row 2)
            for (let c = 0; c < 20; c++) {
                const cellRef = XLSX.utils.encode_cell({ r: 1, c: c });
                const cell = ws[cellRef];
                if (cell) {
                    // Colunas Data/Origem/Destino/Obs - Esquerda
                    if (c === 0 || c === 1 || c === 2 || c === 5 || c === 7 || c === 8 || c === 9 || c === 12 || c === 14 || c === 15 || c === 16 || c === 19) {
                        cell.s = { font: headerFont, fill: headerFill, alignment: { horizontal: 'left' } };
                    } 
                    // Colunas KM/Valor - Direita
                    else if (c === 3 || c === 4 || c === 10 || c === 11 || c === 17 || c === 18) {
                        cell.s = { font: headerFont, fill: headerFill, alignment: { horizontal: 'right' } };
                    }
                    // Separador G e N
                    else if (c === 6 || c === 13) {
                        cell.s = { fill: blackFill };
                    }
                }
            }


            // Aplicar estilos às linhas de dados (A partir da Row 3 - index 2)
            // Lógica de zebra e formatação de números
            for (let r = 2; r < aoaWithHeaders.length; r++) {
                // Checa se é a linha de Somatório Geral para não aplicar o estilo de dados
                if (aoaWithHeaders[r][2] && aoaWithHeaders[r][2].includes("SOMATÓRIO GERAL")) {
                    continue;
                }
                
                // Checa se a linha é o TOTAL DIA (o campo de destino/coluna C, J ou Q começa com "TOTAL DIA")
                const isTotalRow = aoaWithHeaders[r][2] && aoaWithHeaders[r][2].startsWith("TOTAL DIA #");
                
                // Itera por todos os targets para aplicar estilos
                targets.forEach((_, index) => {
                    const startCol = index * 7;
                    const kmCol = startCol + 3;
                    const valorCol = startCol + 4;
                    
                    // Preenchimento de fundo zebra (exceto nas linhas de total)
                    const fill = r % 2 === 1 && !isTotalRow ? { fgColor: { rgb: "1E293B" } } : undefined;
                    
                    // Aplica estilo a KM (Coluna 4, 11, 18)
                    const kmCellRef = XLSX.utils.encode_cell({ r: r, c: kmCol });
                    if (ws[kmCellRef]) {
                        if (!ws[kmCellRef].s) ws[kmCellRef].s = {};
                        ws[kmCellRef].s.alignment = { horizontal: 'right' };
                        ws[kmCellRef].s.fill = fill;
                    }

                    // Aplica estilo a Valor (Coluna 5, 12, 19)
                    const valorCellRef = XLSX.utils.encode_cell({ r: r, c: valorCol });
                    if (ws[valorCellRef]) {
                        if (!ws[valorCellRef].s) ws[valorCellRef].s = {};
                        ws[valorCellRef].s.alignment = { horizontal: 'right' };
                        ws[valorCellRef].s.fill = fill;
                    }
                    
                    // Aplica preenchimento zebra nas colunas de texto (Data, Origem, Destino, Obs)
                    for(let c = startCol; c < startCol + 6; c++) {
                        // Não aplica o fill nas colunas KM e Valor, pois já foi feito acima
                        if(c === kmCol || c === valorCol) continue; 
                        
                        const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                        if (ws[cellRef]) {
                             if (!ws[cellRef].s) ws[cellRef].s = {};
                             ws[cellRef].s.fill = fill;
                        }
                    }

                    // Se for linha de TOTAL DIA, aplica estilo especial
                    if (isTotalRow) {
                        const totalDestinoCol = startCol + 2;
                        
                        // Estilo de preenchimento da linha de Total Dia (exceto Separador)
                        for(let c = startCol; c <= startCol + 5; c++) {
                            const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
                            if (ws[cellRef]) {
                                if (!ws[cellRef].s) ws[cellRef].s = {};
                                ws[cellRef].s.font = whiteFont;
                                ws[cellRef].s.fill = headerFill;
                            }
                        }
                        
                        // Alinhamento para "TOTAL DIA #X"
                        ws[XLSX.utils.encode_cell({ r: r, c: totalDestinoCol })].s.alignment = { horizontal: 'center' };
                        // Alinhamento para KM e Valor
                        ws[XLSX.utils.encode_cell({ r: r, c: kmCol })].s.alignment = { horizontal: 'right' };
                        ws[XLSX.utils.encode_cell({ r: r, c: valorCol })].s.alignment = { horizontal: 'right' };
                    }
                    
                    // Separador G e N (Coluna 6, 13)
                    const sepCol = startCol + 6;
                    const sepCellRef = XLSX.utils.encode_cell({ r: r, c: sepCol });
                    if(ws[sepCellRef]) {
                         if (!ws[sepCellRef].s) ws[sepCellRef].s = {};
                         ws[sepCellRef].s.fill = blackFill;
                    }
                });
            }


            // Aplicar estilos à linha do Somatório Geral (última linha com dados)
            let grandTotalRowIndex = -1;
            // Percorre de 2 (após cabeçalhos) para achar o Somatório Geral
            for(let r = 2; r < aoaWithHeaders.length; r++) {
                if(aoaWithHeaders[r][2] && aoaWithHeaders[r][2].includes("SOMATÓRIO GERAL")) {
                    grandTotalRowIndex = r;
                    break;
                }
            }

            targets.forEach((_, index) => {
                const startCol = index * 7;
                const totalDestinoCol = startCol + 2;
                const totalKMCol = startCol + 3;
                const totalValorCol = startCol + 4;
                const endCol = startCol + 5;
                
                // Estilo de preenchimento da linha do Somatório Geral
                for(let c = startCol; c <= endCol; c++) {
                    const cellRef = XLSX.utils.encode_cell({ r: grandTotalRowIndex, c: c });
                    if (ws[cellRef]) {
                        if (!ws[cellRef].s) ws[cellRef].s = {};
                        ws[cellRef].s.font = whiteFont;
                        ws[cellRef].s.fill = greenFill;
                    }
                }
                
                // Alinhamento
                ws[XLSX.utils.encode_cell({ r: grandTotalRowIndex, c: totalDestinoCol })].s.alignment = { horizontal: 'center' };
                ws[XLSX.utils.encode_cell({ r: grandTotalRowIndex, c: totalKMCol })].s.alignment = { horizontal: 'right' };
                ws[XLSX.utils.encode_cell({ r: grandTotalRowIndex, c: totalValorCol })].s.alignment = { horizontal: 'right' };

                // Separador G e N
                const sepCol = startCol + 6;
                const sepCellRef = XLSX.utils.encode_cell({ r: grandTotalRowIndex, c: sepCol });
                if(ws[sepCellRef]) {
                     if (!ws[sepCellRef].s) ws[sepCellRef].s = {};
                     ws[sepCellRef].s.fill = blackFill;
                }
            });

            // 8. Largura das colunas (20 colunas no total)
            const wscols = [
                { wch: 12 }, { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 15 }, { wch: 30 }, // Target 1 (A-F)
                { wch: 2 }, // Separador G
                { wch: 12 }, { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 15 }, { wch: 30 }, // Target 2 (H-M)
                { wch: 2 }, // Separador N
                { wch: 12 }, { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 15 }, { wch: 30 } // Target 3 (O-T)
            ];
            ws['!cols'] = wscols;


            // 9. Gerar e baixar o arquivo Excel
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatorio Consolidado");
            
            const startFmt = new Date(startDateObj).toLocaleDateString('pt-BR');
            const endFmt = new Date(endDateObj.getUTCDate() - 1 === new Date(endDateObj).getUTCDate() ? endDateObj.setUTCDate(endDateObj.getUTCDate() - 1) && endDateObj : endDateObj.setUTCDate(endDateObj.getUTCDate() - 1) && endDateObj).toLocaleDateString('pt-BR');
            
            const filename = `Relatorio_Consolidado_${startFmt}_ate_${endFmt}.xlsx`;
            
            XLSX.writeFile(wb, filename);

            showToast("Relatório gerado!");
        }
        
    </script>
</body>
</html>